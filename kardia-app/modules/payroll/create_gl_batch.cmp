# Queries to run the January payroll
# by Greg Beeley 02/23/2009
#
# test_obj command script; use the following command line:
# /usr/local/centrallix/test_obj -c /etc/centrallix.conf -f $PWD/run_payroll.to

# Erase what may already be there
query DELETE /apps/kardia/data/Kardia_DB/a_transaction/rows where :a_ledger_number = '0US' and :a_batch_number = PAYBATCH
query DELETE /apps/kardia/data/Kardia_DB/a_transaction_tmp/rows where :a_ledger_number = '0US' and :a_batch_number = PAYBATCH
query DELETE /apps/kardia/data/Kardia_DB/a_batch/rows where :a_ledger_number = '0US' and :a_batch_number = PAYBATCH

# Create batch
query INSERT INTO /apps/kardia/data/Kardia_DB/a_batch/rows  SELECT a_batch_number = PAYBATCH, a_ledger_number = '0US', a_origin = 'PP', a_period = 'PAYPERIOD', a_batch_desc = 'Missionary Payroll PAYPERIOD', a_next_journal_number = 1, a_next_transaction_number = 1, a_default_effective_date = convert(datetime, 'PAYDATE'), s_date_created = getdate(), s_created_by = user_name(), s_date_modified = getdate(), s_modified_by = user_name()

# Handle the pre-tax benefits / pre-payroll transactions (classes B and P -- currently types VEH, TRV, INS)
query INSERT INTO /apps/kardia/data/Kardia_DB/a_transaction_tmp/rows  SELECT a_ledger_number = '0US', a_batch_number = PAYBATCH, a_journal_number=:i:a_payroll_id, :i:a_period, :i:a_effective_date, a_transaction_type='T', a_cost_center = isnull(:i:a_ref_cost_center, :y:a_cost_center), a_account_category=condition(:i:a_ref_account_code > '5000', condition(:c1:a_bal_cost_center = :c2:a_bal_cost_center,'51','52'), condition(:i:a_ref_account_code > '4000', condition(:c1:a_bal_cost_center = :c2:a_bal_cost_center,'41','42') , :a1:a_default_category)), a_account_code = :i:a_ref_account_code, a_amount = :a_actual_amount, a_posted = 0, a_modified = 0, a_corrected = 0, a_correcting = 0, a_reconciled = 0, a_postprocessed = 0, a_postprocess_type = 'XX', a_origin = 'PP', a_receipt_sent = 0, a_receipt_desired = 0, a_first_gift = 0, p_ext_partner_id = :y:p_payee_partner_key, a_goods_provided = $0, s_date_created = getdate(), s_date_modified = getdate(), s_created_by = user_name(), s_modified_by = user_name(), a_comment = :t:a_desc + ' to ' + :i:a_xfer_cost_center  FROM /apps/kardia/data/Kardia_DB/a_payroll_item/rows i, /apps/kardia/data/Kardia_DB/a_payroll/rows y, /apps/kardia/data/Kardia_DB/a_payroll_item_type/rows t, /apps/kardia/data/Kardia_DB/a_cost_center/rows c1, /apps/kardia/data/Kardia_DB/a_cost_center/rows c2, /apps/kardia/data/Kardia_DB/a_account/rows a1  WHERE :i:a_period = 'PAYPERIOD' and :i:a_payroll_id = :y:a_payroll_id and :y:a_ledger_number = '0US' and :i:a_payroll_item_type_code = :t:a_payroll_item_type_code and :t:a_ledger_number = '0US' and (:t:a_payroll_item_class_code = 'B' or :t:a_payroll_item_class_code = 'P') and :c1:a_cost_center = :i:a_ref_cost_center and :c2:a_cost_center = :i:a_xfer_cost_center and :c1:a_ledger_number = '0US' and :c2:a_ledger_number = '0US' and :a1:a_ledger_number = '0US' and :a1:a_account_code = :i:a_ref_account_code
query INSERT INTO /apps/kardia/data/Kardia_DB/a_transaction_tmp/rows  SELECT a_ledger_number = '0US', a_batch_number = PAYBATCH, a_journal_number=:i:a_payroll_id, :i:a_period, :i:a_effective_date, a_transaction_type='T', a_cost_center = :i:a_xfer_cost_center, a_account_category=condition(:i:a_xfer_account_code > '5000', condition(:c1:a_bal_cost_center = :c2:a_bal_cost_center,'51','52'), condition(:i:a_xfer_account_code > '4000', condition(:c1:a_bal_cost_center = :c2:a_bal_cost_center,'41','42') , :a1:a_default_category)), a_account_code = :i:a_xfer_account_code, a_amount = $0 - :a_actual_amount, a_posted = 0, a_modified = 0, a_corrected = 0, a_correcting = 0, a_reconciled = 0, a_postprocessed = 0, a_postprocess_type = 'XX', a_origin = 'PP', a_receipt_sent = 0, a_receipt_desired = 0, a_first_gift = 0, p_ext_partner_id = :y:p_payee_partner_key, a_goods_provided = $0, s_date_created = getdate(), s_date_modified = getdate(), s_created_by = user_name(), s_modified_by = user_name(), a_comment = :t:a_desc + ' from ' + isnull(:i:a_ref_cost_center, :y:a_cost_center)  FROM /apps/kardia/data/Kardia_DB/a_payroll_item/rows i, /apps/kardia/data/Kardia_DB/a_payroll/rows y, /apps/kardia/data/Kardia_DB/a_payroll_item_type/rows t, /apps/kardia/data/Kardia_DB/a_cost_center/rows c1, /apps/kardia/data/Kardia_DB/a_cost_center/rows c2, /apps/kardia/data/Kardia_DB/a_account/rows a1  WHERE :i:a_period = 'PAYPERIOD' and :i:a_payroll_id = :y:a_payroll_id and :y:a_ledger_number = '0US' and :i:a_payroll_item_type_code = :t:a_payroll_item_type_code and :t:a_ledger_number = '0US' and (:t:a_payroll_item_class_code = 'B' or :t:a_payroll_item_class_code = 'P') and :c1:a_cost_center = :i:a_ref_cost_center and :c2:a_cost_center = :i:a_xfer_cost_center and :c1:a_ledger_number = '0US' and :c2:a_ledger_number = '0US' and :a1:a_ledger_number = '0US' and :a1:a_account_code = :i:a_xfer_account_code

# Handle the employer side taxes (class E -- currently types SSE, MDE)
query INSERT INTO /apps/kardia/data/Kardia_DB/a_transaction_tmp/rows  SELECT a_ledger_number = '0US', a_batch_number = PAYBATCH, a_journal_number=:i:a_payroll_id, :i:a_period, :i:a_effective_date, a_transaction_type='T', a_cost_center = :i:a_ref_cost_center, a_account_category=condition(:i:a_ref_account_code > '5000', '50', condition(:i:a_ref_account_code > '4000', '40', :a1:a_default_category)), a_account_code = :i:a_ref_account_code, a_amount = :a_actual_amount, a_posted = 0, a_modified = 0, a_corrected = 0, a_correcting = 0, a_reconciled = 0, a_postprocessed = 0, a_postprocess_type = 'XX', a_origin = 'PP', a_receipt_sent = 0, a_receipt_desired = 0, a_first_gift = 0, p_ext_partner_id = :y:p_payee_partner_key, a_goods_provided = $0, s_date_created = getdate(), s_date_modified = getdate(), s_created_by = user_name(), s_modified_by = user_name(), a_comment = :t:a_desc  FROM /apps/kardia/data/Kardia_DB/a_payroll_item/rows i, /apps/kardia/data/Kardia_DB/a_payroll/rows y, /apps/kardia/data/Kardia_DB/a_payroll_item_type/rows t, /apps/kardia/data/Kardia_DB/a_cost_center/rows c1, /apps/kardia/data/Kardia_DB/a_account/rows a1  WHERE :i:a_period = 'PAYPERIOD' and :i:a_payroll_id = :y:a_payroll_id and :y:a_ledger_number = '0US' and :i:a_payroll_item_type_code = :t:a_payroll_item_type_code and :t:a_ledger_number = '0US' and (:t:a_payroll_item_class_code = 'E') and :c1:a_cost_center = :i:a_ref_cost_center and :c1:a_ledger_number = '0US' and :a1:a_ledger_number = '0US' and :a1:a_account_code = :i:a_ref_account_code
query INSERT INTO /apps/kardia/data/Kardia_DB/a_transaction_tmp/rows  SELECT a_ledger_number = '0US', a_batch_number = PAYBATCH, a_journal_number=:i:a_payroll_id, :i:a_period, :i:a_effective_date, a_transaction_type='T', a_cost_center = :i:a_ref_cost_center, a_account_category=condition(:i:a_xfer_account_code > '5000', '50', condition(:i:a_xfer_account_code > '4000', '40', :a1:a_default_category)), a_account_code = :i:a_xfer_account_code, a_amount = $0 - :a_actual_amount, a_posted = 0, a_modified = 0, a_corrected = 0, a_correcting = 0, a_reconciled = 0, a_postprocessed = 0, a_postprocess_type = 'XX', a_origin = 'PP', a_receipt_sent = 0, a_receipt_desired = 0, a_first_gift = 0, p_ext_partner_id = :y:p_payee_partner_key, a_goods_provided = $0, s_date_created = getdate(), s_date_modified = getdate(), s_created_by = user_name(), s_modified_by = user_name(), a_comment = :t:a_desc  FROM /apps/kardia/data/Kardia_DB/a_payroll_item/rows i, /apps/kardia/data/Kardia_DB/a_payroll/rows y, /apps/kardia/data/Kardia_DB/a_payroll_item_type/rows t, /apps/kardia/data/Kardia_DB/a_cost_center/rows c1, /apps/kardia/data/Kardia_DB/a_account/rows a1  WHERE :i:a_period = 'PAYPERIOD' and :i:a_payroll_id = :y:a_payroll_id and :y:a_ledger_number = '0US' and :i:a_payroll_item_type_code = :t:a_payroll_item_type_code and :t:a_ledger_number = '0US' and (:t:a_payroll_item_class_code = 'E') and :c1:a_cost_center = :i:a_ref_cost_center and :c1:a_ledger_number = '0US' and :a1:a_ledger_number = '0US' and :a1:a_account_code = :i:a_xfer_account_code

# Gross Pay (class G)
query INSERT INTO /apps/kardia/data/Kardia_DB/a_transaction_tmp/rows  SELECT a_ledger_number = '0US', a_batch_number = PAYBATCH, a_journal_number=:i:a_payroll_id, :i:a_period, :i:a_effective_date, a_transaction_type='T', a_cost_center = :i:a_ref_cost_center, a_account_category=condition(:i:a_ref_account_code > '5000', '50', condition(:i:a_ref_account_code > '4000', '40', :a1:a_default_category)), a_account_code = :i:a_ref_account_code, a_amount = :a_actual_amount, a_posted = 0, a_modified = 0, a_corrected = 0, a_correcting = 0, a_reconciled = 0, a_postprocessed = 0, a_postprocess_type = 'XX', a_origin = 'PP', a_receipt_sent = 0, a_receipt_desired = 0, a_first_gift = 0, p_ext_partner_id = :y:p_payee_partner_key, a_goods_provided = $0, s_date_created = getdate(), s_date_modified = getdate(), s_created_by = user_name(), s_modified_by = user_name(), a_comment = :t:a_desc + ' - ' + :y:a_payee_name  FROM /apps/kardia/data/Kardia_DB/a_payroll_item/rows i, /apps/kardia/data/Kardia_DB/a_payroll/rows y, /apps/kardia/data/Kardia_DB/a_payroll_item_type/rows t, /apps/kardia/data/Kardia_DB/a_cost_center/rows c1, /apps/kardia/data/Kardia_DB/a_account/rows a1  WHERE :i:a_period = 'PAYPERIOD' and :i:a_payroll_id = :y:a_payroll_id and :y:a_ledger_number = '0US' and :i:a_payroll_item_type_code = :t:a_payroll_item_type_code and :t:a_ledger_number = '0US' and (:t:a_payroll_item_class_code = 'G') and :c1:a_cost_center = :i:a_ref_cost_center and :c1:a_ledger_number = '0US' and :a1:a_ledger_number = '0US' and :a1:a_account_code = :i:a_ref_account_code
# Personal Gifts / Payables (class M)
query INSERT INTO /apps/kardia/data/Kardia_DB/a_transaction_tmp/rows  SELECT a_ledger_number = '0US', a_batch_number = PAYBATCH, a_journal_number=:i:a_payroll_id, :i:a_period, :i:a_effective_date, a_transaction_type='T', a_cost_center = :i:a_ref_cost_center, a_account_category=condition(:i:a_ref_account_code > '5000', '50', condition(:i:a_ref_account_code > '4000', '40', :a1:a_default_category)), a_account_code = :i:a_ref_account_code, a_amount = :a_actual_amount, a_posted = 0, a_modified = 0, a_corrected = 0, a_correcting = 0, a_reconciled = 0, a_postprocessed = 0, a_postprocess_type = 'XX', a_origin = 'PP', a_receipt_sent = 0, a_receipt_desired = 0, a_first_gift = 0, p_ext_partner_id = :y:p_payee_partner_key, a_goods_provided = $0, s_date_created = getdate(), s_date_modified = getdate(), s_created_by = user_name(), s_modified_by = user_name(), a_comment = :t:a_desc + ' Paid Out - ' + :y:a_payee_name  FROM /apps/kardia/data/Kardia_DB/a_payroll_item/rows i, /apps/kardia/data/Kardia_DB/a_payroll/rows y, /apps/kardia/data/Kardia_DB/a_payroll_item_type/rows t, /apps/kardia/data/Kardia_DB/a_cost_center/rows c1, /apps/kardia/data/Kardia_DB/a_account/rows a1  WHERE :i:a_period = 'PAYPERIOD' and :i:a_payroll_id = :y:a_payroll_id and :y:a_ledger_number = '0US' and :i:a_payroll_item_type_code = :t:a_payroll_item_type_code and :t:a_ledger_number = '0US' and (:t:a_payroll_item_class_code = 'M') and :c1:a_cost_center = :i:a_ref_cost_center and :c1:a_ledger_number = '0US' and :a1:a_ledger_number = '0US' and :a1:a_account_code = :i:a_ref_account_code
# Advances, Withholdings (classes V, T)
query INSERT INTO /apps/kardia/data/Kardia_DB/a_transaction_tmp/rows  SELECT a_ledger_number = '0US', a_batch_number = PAYBATCH, a_journal_number=:i:a_payroll_id, :i:a_period, :i:a_effective_date, a_transaction_type='T', a_cost_center = :i:a_ref_cost_center, a_account_category=condition(:i:a_ref_account_code > '5000', '50', condition(:i:a_ref_account_code > '4000', '40', :a1:a_default_category)), a_account_code = :i:a_ref_account_code, a_amount = $0 - :a_actual_amount, a_posted = 0, a_modified = 0, a_corrected = 0, a_correcting = 0, a_reconciled = 0, a_postprocessed = 0, a_postprocess_type = 'XX', a_origin = 'PP', a_receipt_sent = 0, a_receipt_desired = 0, a_first_gift = 0, p_ext_partner_id = :y:p_payee_partner_key, a_goods_provided = $0, s_date_created = getdate(), s_date_modified = getdate(), s_created_by = user_name(), s_modified_by = user_name(), a_comment = :t:a_desc + ' - ' + :y:a_payee_name  FROM /apps/kardia/data/Kardia_DB/a_payroll_item/rows i, /apps/kardia/data/Kardia_DB/a_payroll/rows y, /apps/kardia/data/Kardia_DB/a_payroll_item_type/rows t, /apps/kardia/data/Kardia_DB/a_cost_center/rows c1, /apps/kardia/data/Kardia_DB/a_account/rows a1  WHERE :i:a_period = 'PAYPERIOD' and :i:a_payroll_id = :y:a_payroll_id and :y:a_ledger_number = '0US' and :i:a_payroll_item_type_code = :t:a_payroll_item_type_code and :t:a_ledger_number = '0US' and (:t:a_payroll_item_class_code = 'V' or :t:a_payroll_item_class_code = 'T') and :c1:a_cost_center = :i:a_ref_cost_center and :c1:a_ledger_number = '0US' and :a1:a_ledger_number = '0US' and :a1:a_account_code = :i:a_ref_account_code
# Net (class N)
query INSERT INTO /apps/kardia/data/Kardia_DB/a_transaction_tmp/rows  SELECT a_ledger_number = '0US', a_batch_number = PAYBATCH, a_journal_number=:i:a_payroll_id, :i:a_period, :i:a_effective_date, a_transaction_type='T', a_cost_center = :i:a_ref_cost_center, a_account_category=condition(:i:a_ref_account_code > '5000', '50', condition(:i:a_ref_account_code > '4000', '40', :a1:a_default_category)), a_account_code = :i:a_ref_account_code, a_amount = $0 - :a_actual_amount, a_posted = 0, a_modified = 0, a_corrected = 0, a_correcting = 0, a_reconciled = 0, a_postprocessed = 0, a_postprocess_type = 'XX', a_origin = 'PP', a_receipt_sent = 0, a_receipt_desired = 0, a_first_gift = 0, p_ext_partner_id = :y:p_payee_partner_key, a_goods_provided = $0, s_date_created = getdate(), s_date_modified = getdate(), s_created_by = user_name(), s_modified_by = user_name(), a_comment = :t:a_desc + ' - ' + :y:a_payee_name  FROM /apps/kardia/data/Kardia_DB/a_payroll_item/rows i, /apps/kardia/data/Kardia_DB/a_payroll/rows y, /apps/kardia/data/Kardia_DB/a_payroll_item_type/rows t, /apps/kardia/data/Kardia_DB/a_cost_center/rows c1, /apps/kardia/data/Kardia_DB/a_account/rows a1  WHERE :i:a_period = 'PAYPERIOD' and :i:a_payroll_id = :y:a_payroll_id and :y:a_ledger_number = '0US' and :i:a_payroll_item_type_code = :t:a_payroll_item_type_code and :t:a_ledger_number = '0US' and (:t:a_payroll_item_class_code = 'N') and :c1:a_cost_center = :i:a_ref_cost_center and :c1:a_ledger_number = '0US' and :a1:a_ledger_number = '0US' and :a1:a_account_code = :i:a_ref_account_code

# Transfer to main trx file
query INSERT INTO /apps/kardia/data/Kardia_DB/a_transaction/rows  SELECT :a_ledger_number, :a_batch_number, :a_journal_number, :a_transaction_number, :a_period, :a_effective_date, :a_transaction_type, a_posted=0, a_modified=0, a_corrected=0, a_correcting=0, a_reconciled=0, a_postprocessed=0, a_postprocess_type = 'XX', a_origin = 'PP', a_receipt_sent = 0, a_receipt_desired = 0, a_first_gift = 0, a_goods_provided = $0, :s_date_created, :s_date_modified, :s_created_by, :s_modified_by, :a_comment, :a_account_code, :a_account_category, :a_amount, :a_cost_center  FROM /apps/kardia/data/Kardia_DB/a_transaction_tmp/rows WHERE :a_batch_number = PAYBATCH and :a_origin = 'PP' and :a_ledger_number = '0US' and :a_period = 'PAYPERIOD'  ORDER BY :a_ledger_number, :a_batch_number, :a_journal_number, :a_transaction_number

# Transfer the liabilities to 0US000
query INSERT INTO /apps/kardia/data/Kardia_DB/a_transaction/rows  SELECT :a_ledger_number, :a_batch_number, a_journal_number = 900, :a_period, :a_effective_date, :a_transaction_type, a_posted=0, a_modified=0, a_corrected=0, a_correcting=0, a_reconciled=0, a_postprocessed=0, a_postprocess_type = 'XX', a_origin = 'PP', a_receipt_sent = 0, a_receipt_desired = 0, a_first_gift = 0, a_goods_provided = $0, :s_date_created, :s_date_modified, :s_created_by, :s_modified_by, a_comment = 'Payroll Liabilities Transfer to 0US000', :a_account_code, :a_account_category, a_amount = $0 - sum(:a_amount), :a_cost_center  FROM /apps/kardia/data/Kardia_DB/a_transaction_tmp/rows WHERE :a_batch_number = PAYBATCH and :a_origin = 'PP' and :a_ledger_number = '0US' and :a_period = 'PAYPERIOD' and :a_account_code >= '2000' and :a_account_code <= '2999' and :a_account_code != '2120'  GROUP BY :a_cost_center, :a_account_code
query INSERT INTO /apps/kardia/data/Kardia_DB/a_transaction/rows  SELECT :a_ledger_number, :a_batch_number, a_journal_number = 900, :a_period, :a_effective_date, :a_transaction_type, a_posted=0, a_modified=0, a_corrected=0, a_correcting=0, a_reconciled=0, a_postprocessed=0, a_postprocess_type = 'XX', a_origin = 'PP', a_receipt_sent = 0, a_receipt_desired = 0, a_first_gift = 0, a_goods_provided = $0, :s_date_created, :s_date_modified, :s_created_by, :s_modified_by, a_comment = 'Payroll Liabilities Transfer', :a_account_code, :a_account_category, a_amount = sum(:a_amount), a_cost_center = '0US000'  FROM /apps/kardia/data/Kardia_DB/a_transaction_tmp/rows WHERE :a_batch_number = PAYBATCH and :a_origin = 'PP' and :a_ledger_number = '0US' and :a_period = 'PAYPERIOD' and :a_account_code >= '2000' and :a_account_code <= '2999' and :a_account_code != '2120'  GROUP BY :a_account_code
