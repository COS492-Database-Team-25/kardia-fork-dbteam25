$Version=2$
profile_timeline "widget/component-decl"
    {
    width=442;
    height=450;

    // Refresh of our data
    Refresh "widget/component-decl-action" { }

    // Iconbar passed in so we can access the 'EnabledTypes' property it has
    iconbar "widget/parameter" { type=object; deploy_to_client=yes; }
    profile "widget/parameter" { type=object; deploy_to_client=yes; }

    // Collaborator osrc provides us information about the logged-in user
    collaborator_osrc "widget/parameter" { type=object; deploy_to_client=yes; }

    // Currently selected partner
    partner_osrc "widget/parameter" { type=object; find_container="widget/osrc"; }

    onRefresh "widget/connector" { event=Refresh; target=timeline_osrc; action=Refresh; }
    
    profile_timeline_vbox "widget/vbox"
	{
	x=0; y=0;
	width=442; height=450;
	spacing=8;

	timeline_scroll_pane "widget/pane"
	    {
	    height=450;
	    style=flat;

	    timeline_osrc "widget/osrc"
		{
		enabled_types "widget/parameter" { type=string; default=runclient(:iconbar:EnabledTypes); }
		my_id "widget/parameter" { type=string; default=runclient(:collaborator_osrc:p_partner_key); }

		sql = " select
			    img = :c:icon,
			    detail_height = :c:height,
			    :e:e_activity_date,
			    :e:e_activity_type,
			    :e:e_reference_info,
			    :e:e_info,
			    shortdate = substring(convert(string,:e:e_activity_date),1,11),
			    datewhom = condition(:e:e_whom == :parameters:my_id, 'Me', condition(char_length(isnull(:p:p_org_name,'')) > 0, :p:p_org_name, condition(char_length(:p:p_preferred_name) > 0, :p:p_preferred_name, :p:p_given_name) + ' ' + :p:p_surname)) + ' on ' + substring(convert(string,:e:e_activity_date),1,11)
			from
			    '/apps/kardia/modules/crm/timeline.qy?partner_key=000000&my_cclist=' e,
			    /apps/kardia/data/Kardia_DB/p_partner/rows p,
			    object wildcard '/apps/kardia/modules/crm/plugin_crm_timeline_*.cmp' c
			where
			    :p:p_partner_key =* :e:e_whom and
			    charindex(:e:e_activity_type, :parameters:enabled_types) > 0 and
			    :c:type = :e:e_activity_type
			";
		readahead=50;
		replicasize=50;
		baseobj = "/apps/kardia/modules/crm/timeline.qy?partner_key=000000&my_cclist=";

		refresh_on_partner_change "widget/connector" { source=partner_osrc; event=EndQuery; action=ChangeSource; Source=runclient("/apps/kardia/modules/crm/timeline.qy?partner_key=" + :partner_osrc:p_partner_key + "&my_cclist=" + :collaborator_osrc:cclist); }

		refresh_on_options_change "widget/connector" { source=iconbar; event=TypesChange; action=Refresh; }

		timeline_table "widget/table"
		    {
		    x=0; y=0;
		    height=450;
		    width=442;
		    //row_border_color="#e0e0e0";
		    row_border_radius=4;
		    //row_shadow_offset=1;
		    //row_shadow_color="#c0c0c0";
		    demand_scrollbar = yes;
		    overlap_scrollbar = yes;
		    initial_selection = no;
		    colsep = 0;
		    titlebar = no;
		    min_rowheight = 16;
		    max_rowheight = 200;
		    cellvspacing = 4;
		    row1_bgcolor = white;
		    row2_bgcolor = white;
		    show_selection = yes;
		    inner_padding = 2;
		    rowhighlight_bgcolor = "#fff090";
		    textcolorhighlight = "#000000";

		    detail_rows "widget/repeat"
			{
			sql = "	select
				    path = :cx__pathname,
				    :type,
				    :height,
				    :icon
				from
				    object wildcard '/apps/kardia/modules/crm/plugin_crm_timeline_*.cmp'
				";

			detail_item "widget/table-row-detail"
			    {
			    condition=runserver(:detail_rows:height > 0);
			    display_for=runclient(:timeline_osrc:e_activity_type == runserver(:detail_rows:type));
			    height=runserver(:detail_rows:height + 8);
			    width=442;

			    detail_cmp "widget/component"
				{
				x=4; y=4;
				width=434;
				height=runserver(:detail_rows:height);
				fl_height=0;
				path = runserver(:detail_rows:path);
				partner_osrc = partner_osrc;
				timeline_osrc = timeline_osrc;
				profile = profile;
				collaborator_osrc = collaborator_osrc;
				}
			    }
			}

		    t_img "widget/table-column" { title=""; fieldname="img"; width=36; type=image; align=center; }
		    //t_date "widget/table-column" { title="Date"; fieldname="shortdate"; width=50; }
		    t_info "widget/table-column" { title="Description"; fieldname="e_info"; width=406; wrap=yes; caption_fieldname=datewhom; caption_textcolor = "#a0a0a0"; style=bold; caption_style=italic; }
		    }
		}
	    }
	}
    }
